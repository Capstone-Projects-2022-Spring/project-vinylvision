<!doctype html>
<html>
<head>
    <title>VinylVision</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
    <h1>
        VinylVision Spotify Album Player
    </h1>

    <div id="tokens">
        <h2>Tokens</h2>
        <dl>
            <dt>Access Token</dt>
            <dd id="access-token">token1</dd>
            <dt>Refresh Token</dt>
            <dd id="refresh-token">token2</dd>
        </dl>
    </div>

    <div id="search">
        <label for="search_tags">Search:</label>
        <input type="text" name="search_tags" id="search_tags" placeholder="Album Guess" style="width:300px"><br><br>
        <input type="button" onclick="searchAlbums(document.getElementById('search_tags').value)" value="Search" />
    </div>
    <br><br>
    <div id="player">
        <label for="artist" id="artist_text">Artist:</label>
        <input name="artist" id="artist" readonly style="width:400px"><br><br>

        <label for="album_name" data-uri="" data-url="">Album:</label>
        <input name="album_name" id="album_name" readonly style="width:300px"><br><br>
        <input type="button" onclick="playAlbum()" value="Play Album" /><br><br>

        <label for="tracks">Tracks:</label>
        <select name="tracks" id="tracks"></select><br><br>
        <input type="button" onclick="playTrack()" value="Play Track" />
    </div>

    <div id="logout">
        <a href="/spotify/logout">Back</a>
    </div>

    <script>
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        function searchAlbums(query) {
            if (query == "") return; //if empty, can require search tags, but dont need to
            //console.log(query)
            accessToken = getHashParams().access_token
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                data: {
                    q: query,
                    type: 'album',
                    limit: 5
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function (response) {
                    //console.log(response.albums)
                    console.log(response.albums.items[0])
                    console.log(response.albums.items[0].name)
                    //add album name
                    var albumNameDiv = document.getElementById("album_name")
                    albumNameDiv.value = response.albums.items[0].name
                    albumNameDiv.dataset.uri = response.albums.items[0].uri
                    albumNameDiv.dataset.url = response.albums.items[0].external_urls.spotify
                    //get artist names
                    var artistDiv = document.getElementById("artist")
                    artistDiv.value = response.albums.items[0].artists[0].name
                    document.getElementById("artist_text").innerHTML = "Artist:"
                    for (let i = 1; i < response.albums.items[0].artists.length; i++) {
                        document.getElementById("artist_text").innerHTML = "Artists:"
                        artistDiv.value += ", " + response.albums.items[0].artists[i].name
                    }

                    fetchTracks(response.albums.items[0].id, accessToken)
                }
            });
        };

        function fetchTracks(albumId, accessToken) {
            $.ajax({
                url: 'https://api.spotify.com/v1/albums/' + albumId + '/tracks',
                data: {
                    limit: 50
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function (response) {
                    console.log(response)
                    //add tracks to dropdown
                    var tracks = document.getElementById("tracks")
                    tracks.innerHTML = null
                    for (let i = 0; i < response.items.length; i++) {
                        //console.log(response.items[i].name)
                        //tracks.innerHTML += `<option value=${i}>` + response.items[i].name + '</option>'
                        tracks.innerHTML += `<option value=${response.items[i].external_urls.spotify}>` + response.items[i].name + '</option>'
                    }
                    //play(accessToken)
                }
            });
        };

        function playAlbum() {
            window.open(document.getElementById("album_name").getAttribute("data-url"), "_blank")
        }

        function playTrack() {
            window.open(document.getElementById("tracks").value, "_blank")
        }

        //impossible to use without premium
        /*function play(accessToken) {
            let trackIndex = document.getElementById("tracks").value;
            let albumUri = document.getElementById("album_name").getAttribute("data-uri");
            console.log(albumUri)
            $.ajax({
                method: "PUT",
                url: 'https://api.spotify.com/v1/me/player/play',
                data: {
                    context_uri: albumUri,
                    offset: {
                        position: trackIndex
                    },
                    position_ms: 0
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function (response) {
                    console.log(response)
                }
            });
        }*/

        (function () {

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    document.getElementById('access-token').innerHTML = access_token.toString();
                    document.getElementById('refresh-token').innerHTML = refresh_token.toString();
                }
            }
        })();
    </script>
</body>
</html>


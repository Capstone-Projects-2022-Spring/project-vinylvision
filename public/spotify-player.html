<!doctype html>
<html>
<head>
    <title>VinylVision</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
    <h1>
        VinylVision Spotify Album Player
    </h1>

    <div id="search">
        <label for="search_tags">Search:</label>
        <input type="text" name="search_tags" id="search_tags" placeholder="Album Guess" style="width:300px"><br><br>
        <input type="button" onclick="searchAlbums(document.getElementById('search_tags').value)" value="Search" />
    </div>
    <br><br>
    <div id="player">
        
        <label for="artist" id="artist_text">Artist:</label>
        <input name="artist" id="artist" readonly style="width:400px"><br><br>

        <label for="album_name" data-uri="" data-url="">Album:</label>
        <input name="album_name" id="album_name" readonly style="width:300px"><br><br>
        <div id="imageDiv"></div><br>
        <input type="button" onclick="playAlbum()" value="Open Album" /><br><br>

        <label for="tracks">Tracks:</label>
        <select name="tracks" id="tracks"></select><br><br>
        <input type="button" onclick="playTrack()" value="Open Track" />
    </div>
    <br>
    <div id="logout">
        <a href="/spotify/logout">Back to Home Page</a>
    </div>

    <script>
        /**
          * Obtains parameters from the hash of the URL
          * @return Object
          */
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        //get cookie with name cname
        function getCookie(cname) {
            let name = cname + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        //check if there's a guess in the parameters and autofill in the fields
        var guess = getHashParams().guess
        if (guess != undefined) {
            document.getElementById('search_tags').value = guess
            searchAlbums(guess)
        }

        //search for an album with the tags from query
        function searchAlbums(query) {
            if (query == "") return; //if empty, can require search tags, but dont need to
            //console.log(getCookie('spotifyAccessToken'))
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                data: {
                    q: query,
                    type: 'album',
                    limit: 5
                },
                headers: {
                    'Authorization': 'Bearer ' + getCookie('spotifyAccessToken')
                },
                success: function (response) {
                    //console.log(response.albums)
                    var album = response.albums.items[0]
                    console.log(album)
                    //console.log(album.name)
                    document.getElementById("imageDiv").innerHTML = `<img src=${album.images[1].url} alt='${album.name} Album Cover' width='200px'>`

                    //add album name
                    var albumNameDiv = document.getElementById("album_name")
                    albumNameDiv.value = album.name
                    albumNameDiv.dataset.uri = album.uri
                    albumNameDiv.dataset.url = album.external_urls.spotify

                    //add artist names
                    var artistDiv = document.getElementById("artist")
                    artistDiv.value = album.artists[0].name
                    document.getElementById("artist_text").innerHTML = "Artist:"
                    for (let i = 1; i < album.artists.length; i++) {
                        document.getElementById("artist_text").innerHTML = "Artists:"
                        artistDiv.value += ", " + album.artists[i].name
                    }

                    //then fetch the tracks
                    fetchTracks(album.id)
                }
            });
        };

        function fetchTracks(albumId) {
            $.ajax({
                url: 'https://api.spotify.com/v1/albums/' + albumId + '/tracks',
                data: {
                    limit: 50
                },
                headers: {
                    'Authorization': 'Bearer ' + getCookie('spotifyAccessToken')
                },
                success: function (response) {
                    //console.log(response)
                    //add tracks to dropdown
                    var tracksDiv = document.getElementById("tracks")
                    tracksDiv.innerHTML = null
                    var tracks = response.items
                    for (let i = 0; i < tracks.length; i++) {
                        //console.log(response.items[i].name)
                        //tracks.innerHTML += `<option value=${i}>` + response.items[i].name + '</option>'
                        tracksDiv.innerHTML += `<option value=${tracks[i].external_urls.spotify}>` + tracks[i].name + '</option>'
                    }
                    //play(accessToken)
                }
            });
        };

        function playAlbum() {
            var dataUrl = document.getElementById("album_name").getAttribute("data-url")
            if (dataUrl) {
                window.open(dataUrl, "_blank")
            }
        }

        function playTrack() {
            var dataUrl = document.getElementById("tracks").value
            if (dataUrl) {
                window.open(dataUrl, "_blank")
            }
        }

        //impossible to use without premium
        /*function play(accessToken) {
            let trackIndex = document.getElementById("tracks").value;
            let albumUri = document.getElementById("album_name").getAttribute("data-uri");
            console.log(albumUri)
            $.ajax({
                method: "PUT",
                url: 'https://api.spotify.com/v1/me/player/play',
                data: {
                    context_uri: albumUri,
                    offset: {
                        position: trackIndex
                    },
                    position_ms: 0
                },
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function (response) {
                    console.log(response)
                }
            });
        }*/
    </script>
</body>
</html>


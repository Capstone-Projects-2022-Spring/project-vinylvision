<!doctype html>
<html>
<head>
    <title>VinylVision</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
    <h1>
        VinylVision Spotify Album Player
    </h1>

    <div id="tokens">
        <h2>Tokens</h2>
        <dl>
            <dt>Access Token</dt>
            <dd id="access-token">token1</dd>
            <dt>Refresh Token</dt>
            <dd id="refresh-token">token2</dd>
        </dl>
    </div>

    <label for="search_tags">Search:</label>
    <input type="text" name="search_tags" id="search_tags" placeholder="Album Guess" style="width:300px"><br><br>
    <input type="button" onclick="searchAlbums(document.getElementById('search_tags').value)" value="Search" />
    <br><br>
    <label for="artist" id="artist_text">Artist:</label>
    <input name="artist" id="artist" readonly style="width:400px"><br><br>
    <label for="album_name">Album:</label>
    <input name="album_name" id="album_name" readonly style="width:300px"><br><br>
    <label for="tracks">Tracks:</label>
    <select name="tracks" id="tracks">
    </select>

    <div id="logout">
        <a href="/spotify/logout">Back</a>
    </div>

    <script>
        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        function searchAlbums(query) {
            if (query == "") return; //if empty, can require search tags, but dont need to
            //console.log(query)
            accessToken = getHashParams().access_token
            $.ajax({
                url: 'https://api.spotify.com/v1/search',
                data: {
                    q: query,
                    type: 'album',
                    limit: 5,
                    access_token: accessToken
                },
                /*headers: {
                    'Authorization' : 'Bearer' + getHashParams().access_token
                },*/
                success: function (response) {
                    //console.log(response.albums)
                    console.log(response.albums.items[0])
                    console.log(response.albums.items[0].name)
                    //get artist names
                    var artistDiv = document.getElementById("artist")
                    artistDiv.value = response.albums.items[0].artists[0].name
                    document.getElementById("artist_text").innerHTML = "Artist:"
                    for (let i = 1; i < response.albums.items[0].artists.length; i++) {
                        document.getElementById("artist_text").innerHTML = "Artists:"
                        artistDiv.value += ", " + response.albums.items[0].artists[i].name
                    }
                    
                    document.getElementById("album_name").value = response.albums.items[0].name
                    fetchTracks(response.albums.items[0].id, accessToken)
                }
            });
        };

        function fetchTracks(albumId, accessToken) {
            $.ajax({
                url: 'https://api.spotify.com/v1/albums/' + albumId + '/tracks',
                data: {
                    limit: 50,
                    access_token: accessToken
                },
                success: function (response) {
                    console.log(response)
                    //add tracks to dropdown
                    var tracks = document.getElementById("tracks")
                    tracks.innerHTML = null
                    for (let i = 0; i < response.items.length; i++) {
                        //console.log(response.items[i].name)
                        tracks.innerHTML += '<option>' + response.items[i].name + '</option>'
                    }
                }
            });
        };

        (function () {

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    document.getElementById('access-token').innerHTML = access_token.toString();
                    document.getElementById('refresh-token').innerHTML = refresh_token.toString();
                }
            }
        })();
    </script>
</body>
</html>

